generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// user roles: 1 -> user, 2 -> admin, 3 -> super_admin
// user status: 1 -> active, 2 -> banned
// user lang: en -> English, zh -> Chinese(Simplified), ja -> Japanese
enum UserLang {
  en
  zh
  ja
}

model User {
  id       Int     @id @default(autoincrement())
  name     String  @unique @db.VarChar(20)
  email    String  @unique @db.VarChar(255)
  password String  @db.VarChar(255)
  avatar   String?
  cover    String?

  games                        Game[]                     @relation("user_create_game")
  game_download_resources      GameDownloadResource[]     @relation("user_create_game_download_resource")
  game_download_resource_files GameDownloadResourceFile[] @relation("user_create_game_download_resource_file")
  comments                     Comment[]                  @relation("user_create_comment")

  favorite_games GameFavoriteRelation[] @relation("user_favorite_game")

  lang   UserLang @default(en)
  role   Int      @default(1)
  status Int      @default(1)

  email_verified_at  DateTime?
  last_login_at      DateTime?
  two_factor_enabled Boolean   @default(false)

  created  DateTime           @default(now())
  updated  DateTime           @updatedAt
  sessions UserLoginSession[] @relation("user_login_session")

  @@index([email])
  @@index([name])
  @@index([created])
  @@map("users")
}

// user login session status: 1 -> active, 2 -> rotated, 3 -> reused, 4 -> blocked
model UserLoginSession {
  id Int @id @default(autoincrement())

  user_id              Int
  user                 User   @relation("user_login_session", fields: [user_id], references: [id])
  refresh_token_hash   String @db.VarChar(255)
  refresh_token_prefix String @db.VarChar(32)
  status               Int    @default(1)

  // Rotation chain / family for bulk revoke
  family_id         String             @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  replaced_by_id    Int?
  replaced_by       UserLoginSession?  @relation("session_replacement", fields: [replaced_by_id], references: [id])
  replaced_sessions UserLoginSession[] @relation("session_replacement")

  expires_at     DateTime
  last_used_at   DateTime?
  rotated_at     DateTime?
  reused_at      DateTime?
  blocked_at     DateTime?
  blocked_reason String?   @db.VarChar(255)

  ip          String?
  user_agent  String?
  device_info String?

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([refresh_token_prefix])
  @@index([family_id])
  @@index([user_id, status])
  @@map("user_login_sessions")
}

// game status: 1 -> visible, 2 -> hide
// game staffs: Array<Record<name, role>>
// extra_info: Array<Record<key, value>>
model Game {
  id         Int         @id @default(autoincrement())
  v_id       String?
  b_id       String?
  title_jp   String      @default("") @db.VarChar(255)
  title_zh   String      @default("") @db.VarChar(255)
  title_en   String      @default("") @db.VarChar(255)
  aliases    String[]    @default([])
  intro_jp   String      @default("") @db.VarChar(2000)
  intro_zh   String      @default("") @db.VarChar(2000)
  intro_en   String      @default("") @db.VarChar(2000)
  covers     GameCover[] @relation("game_cover")
  images     String[]    @default([])
  extra_info Json?       @default(dbgenerated("'[]'::jsonb")) @db.JsonB

  tags       String[]                @default([])
  developers GameDeveloperRelation[] @relation("game_developer")
  characters GameCharacterRelation[] @relation("game_character")
  staffs     Json?                   @default(dbgenerated("'[]'::jsonb")) @db.JsonB

  nsfw     Boolean  @default(false)
  type     String?
  platform String[] @default([])

  download_resources GameDownloadResource[] @relation("game_download_resource")

  creator_id Int
  creator    User @relation("user_create_game", fields: [creator_id], references: [id])

  favorite_users GameFavoriteRelation[] @relation("game_favorite")

  comments Comment[] @relation("game_comment")

  status  Int      @default(1)
  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([b_id, v_id])
  @@index([b_id, v_id])
  @@index([b_id])
  @@index([v_id])
  @@map("games")
}

model GameCover {
  id Int @id @default(autoincrement())

  language String
  url      String
  type     String
  dims     Int[]

  created DateTime @default(now())
  updated DateTime @updatedAt

  game_id Int
  game    Game @relation("game_cover", fields: [game_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("game_covers")
}

// extra_info: Array<Record<key, value>>
model GameDeveloper {
  id         Int      @id @default(autoincrement())
  b_id       String?
  v_id       String?
  name       String   @default("") @db.VarChar(255)
  aliases    String[] @default([])
  logo       String?
  intro_jp   String   @default("") @db.VarChar(2000)
  intro_zh   String   @default("") @db.VarChar(2000)
  intro_en   String   @default("") @db.VarChar(2000)
  extra_info Json?    @default(dbgenerated("'[]'::jsonb")) @db.JsonB

  games GameDeveloperRelation[] @relation("game_produce")

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([b_id, v_id])
  @@index([b_id, v_id])
  @@index([b_id])
  @@index([v_id])
  @@map("game_developers")
}

model GameDeveloperRelation {
  id           Int     @id @default(autoincrement())
  role         String?
  game_id      Int
  developer_id Int

  game      Game          @relation("game_developer", fields: [game_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  developer GameDeveloper @relation("game_produce", fields: [developer_id], references: [id])

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([game_id, developer_id])
  @@map("game_developer_relations")
}

// extra_info: Array<Record<key, value>>
model GameCharacter {
  id         Int      @id @default(autoincrement())
  b_id       String?
  v_id       String?
  image      String?
  name_jp    String   @default("")
  name_zh    String?
  name_en    String?
  aliases    String[] @default([])
  intro_jp   String   @default("") @db.VarChar(2000)
  intro_zh   String   @default("") @db.VarChar(2000)
  intro_en   String   @default("") @db.VarChar(2000)
  gender     String?
  extra_info Json?    @default(dbgenerated("'[]'::jsonb")) @db.JsonB

  games GameCharacterRelation[] @relation("game_appear_on")

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([b_id, v_id])
  @@index([b_id, v_id])
  @@index([b_id])
  @@index([v_id])
  @@map("game_characters")
}

// extra_info: Array<Record<key, value>>
model GameCharacterRelation {
  id         Int     @id @default(autoincrement())
  image      String?
  actor      String?
  role       String?
  extra_info Json?   @default(dbgenerated("'[]'::jsonb")) @db.JsonB

  game_id      Int
  character_id Int

  game      Game          @relation("game_character", fields: [game_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  character GameCharacter @relation("game_appear_on", fields: [character_id], references: [id])

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([game_id, character_id])
  @@map("game_character_relations")
}

model GameDownloadResource {
  id      Int                        @id @default(autoincrement())
  game_id Int
  game    Game                       @relation("game_download_resource", fields: [game_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  files   GameDownloadResourceFile[] @relation("game_download_resource_files")

  creator_id Int
  creator    User @relation("user_create_game_download_resource", fields: [creator_id], references: [id])

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@map("game_download_resources")
}

// file type: 1 -> s3 native, 2 -> direct link, 3 -> third party link
model GameDownloadResourceFile {
  id        Int     @id @default(autoincrement())
  type      Int     @default(1)
  file_name String
  file_path String?
  file_size Int
  file_url  String?
  file_hash String

  game_download_resource_id Int
  game_download_resource    GameDownloadResource @relation("game_download_resource_files", fields: [game_download_resource_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  creator_id Int
  creator    User @relation("user_create_game_download_resource_file", fields: [creator_id], references: [id])

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@map("game_download_resource_files")
}

model GameFavoriteRelation {
  id      Int @id @default(autoincrement())
  user_id Int
  game_id Int

  user User @relation("user_favorite_game", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  game Game @relation("game_favorite", fields: [game_id], references: [id])

  @@unique([user_id, game_id])
  @@map("game_favorite_relations")
}

model Comment {
  id      Int    @id @default(autoincrement())
  content String

  game_id Int
  game    Game @relation("game_comment", fields: [game_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  creator_id Int
  creator    User @relation("user_create_comment", fields: [creator_id], references: [id])

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@map("comments")
}
