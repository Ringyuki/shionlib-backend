-- CreateEnum
CREATE TYPE "MalwareScanCaseStatus" AS ENUM ('PENDING', 'RELEASED_FALSE_POSITIVE', 'DELETED');

-- CreateEnum
CREATE TYPE "MalwareScanDecisionSource" AS ENUM ('ADMIN_ALLOW', 'ADMIN_DELETE', 'TIMEOUT_AUTO_DELETE');

-- AlterTable
ALTER TABLE "game_developers" ALTER COLUMN "extra_info" SET DEFAULT '[]'::jsonb;

-- AlterTable
ALTER TABLE "game_download_resource_files" ADD COLUMN     "is_virus_false_positive" BOOLEAN NOT NULL DEFAULT false;

-- AlterTable
ALTER TABLE "games" ALTER COLUMN "extra_info" SET DEFAULT '[]'::jsonb,
ALTER COLUMN "staffs" SET DEFAULT '[]'::jsonb;

-- CreateTable
CREATE TABLE "malware_scan_cases" (
    "id" SERIAL NOT NULL,
    "file_id" INTEGER,
    "resource_id" INTEGER,
    "game_id" INTEGER,
    "uploader_id" INTEGER NOT NULL,
    "reviewed_by" INTEGER,
    "status" "MalwareScanCaseStatus" NOT NULL DEFAULT 'PENDING',
    "decision_source" "MalwareScanDecisionSource",
    "review_note" VARCHAR(500),
    "review_deadline" TIMESTAMP(3) NOT NULL,
    "reviewed_at" TIMESTAMP(3),
    "detector" VARCHAR(64) NOT NULL,
    "detected_viruses" TEXT[] DEFAULT ARRAY[]::TEXT[],
    "scan_result" JSONB,
    "scan_log_path" VARCHAR(255),
    "scan_log_excerpt" TEXT,
    "notify_uploader_on_allow" BOOLEAN NOT NULL DEFAULT true,
    "uploader_notified_at" TIMESTAMP(3),
    "file_name" TEXT NOT NULL,
    "file_size" BIGINT NOT NULL,
    "hash_algorithm" "HashAlgorithm",
    "file_hash" TEXT NOT NULL,
    "created" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "malware_scan_cases_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "malware_scan_cases_status_review_deadline_idx" ON "malware_scan_cases"("status", "review_deadline");

-- CreateIndex
CREATE INDEX "malware_scan_cases_uploader_id_created_idx" ON "malware_scan_cases"("uploader_id", "created");

-- CreateIndex
CREATE INDEX "malware_scan_cases_resource_id_created_idx" ON "malware_scan_cases"("resource_id", "created");

-- CreateIndex
CREATE INDEX "malware_scan_cases_game_id_created_idx" ON "malware_scan_cases"("game_id", "created");

-- CreateIndex
CREATE INDEX "malware_scan_cases_file_id_created_idx" ON "malware_scan_cases"("file_id", "created");

-- AddForeignKey
ALTER TABLE "malware_scan_cases" ADD CONSTRAINT "malware_scan_cases_file_id_fkey" FOREIGN KEY ("file_id") REFERENCES "game_download_resource_files"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "malware_scan_cases" ADD CONSTRAINT "malware_scan_cases_resource_id_fkey" FOREIGN KEY ("resource_id") REFERENCES "game_download_resources"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "malware_scan_cases" ADD CONSTRAINT "malware_scan_cases_game_id_fkey" FOREIGN KEY ("game_id") REFERENCES "games"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "malware_scan_cases" ADD CONSTRAINT "malware_scan_cases_uploader_id_fkey" FOREIGN KEY ("uploader_id") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "malware_scan_cases" ADD CONSTRAINT "malware_scan_cases_reviewed_by_fkey" FOREIGN KEY ("reviewed_by") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE;
