name: deploy backend

on:
  push:
    branches: ['main']

concurrency:
  group: shionlib-backend-deploy
  cancel-in-progress: true

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: shionlib_ci
          POSTGRES_USER: shionlib
          POSTGRES_PASSWORD: shionlib
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U shionlib -d shionlib_ci" 
          --health-interval=10s 
          --health-timeout=5s 
          --health-retries=10

    env:
      DATABASE_URL: postgresql://shionlib:shionlib@localhost:5432/shionlib_ci?schema=public

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: pnpm prisma:generate

      - name: ESLint
        run: pnpm lint:check

      - name: Prettier
        run: pnpm format:check

      - name: Type check
        run: pnpm typecheck

      - name: Prisma validate
        run: pnpm prisma:validate

      - name: Prepare test DB schema
        run: pnpm prisma:push

      - name: Unit tests
        run: pnpm test -- --passWithNoTests

      - name: E2E tests
        run: pnpm test:e2e -- --passWithNoTests

  build-and-deploy:
    name: Build and Deploy
    needs: checks
    environment: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: pnpm prisma:generate

      - name: Build
        run: pnpm build

      - name: Archive artifact
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          TAR_NAME="release-${SHORT_SHA}.tgz"
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          tar -czf "$TAR_NAME" \
            dist \
            i18n \
            package.json \
            pnpm-lock.yaml \
            prisma \
            prisma.config.ts

      - name: Install cloudflared
        run: |
          set -e
          mkdir -p /tmp/cloudflared
          curl -sL -o /tmp/cloudflared/cloudflared \
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x /tmp/cloudflared/cloudflared
          /tmp/cloudflared/cloudflared --version

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Upload to server
        env:
          SSH_PROXY_COMMAND: '/tmp/cloudflared/cloudflared access ssh --id ${{ secrets.SSH_CLOUDFLARED_ID }} --secret ${{ secrets.SSH_CLOUDFLARED_SECRET }} --hostname %h'
        run: |
          scp \
            -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            -o ProxyCommand="$SSH_PROXY_COMMAND" \
            -P ${{ secrets.SSH_PORT }} \
            "${TAR_NAME}" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/${TAR_NAME}"

      - name: Deploy on server
        env:
          SSH_PROXY_COMMAND: '/tmp/cloudflared/cloudflared access ssh --id ${{ secrets.SSH_CLOUDFLARED_ID }} --secret ${{ secrets.SSH_CLOUDFLARED_SECRET }} --hostname %h'
        run: |
          ssh \
            -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            -o ProxyCommand="$SSH_PROXY_COMMAND" \
            -p ${{ secrets.SSH_PORT }} \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            "DEPLOY_DIR='${{ secrets.DEPLOY_DIR }}' GITHUB_SHA='${{ github.sha }}' bash -s" << 'EOF'
          [ -f ~/.bashrc ] && . ~/.bashrc
          [ -f ~/.profile ] && . ~/.profile

          set -euo pipefail

          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm use 24 >/dev/null || true
          node -v || true

          export PATH="/root/.nvm/versions/node/v24.11.1/bin:$PATH"
          KEEP_RELEASES=5

          mkdir -p "$DEPLOY_DIR/releases"

          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          TS_UTC=$(date -u +%Y%m%d%H%M%S)
          RELEASE_NAME="${TS_UTC}-${SHORT_SHA}"
          RELEASE_DIR="$DEPLOY_DIR/releases/$RELEASE_NAME"
          SHARED_DIR="$DEPLOY_DIR/shared"

          TAR_NAME="release-${SHORT_SHA}.tgz"
          mkdir -p "$RELEASE_DIR"
          tar -xzf "/tmp/${TAR_NAME}" -C "$RELEASE_DIR"
          rm -f "/tmp/${TAR_NAME}"

          if [ -f "$SHARED_DIR/.env" ]; then
            ln -sfn "$SHARED_DIR/.env" "$RELEASE_DIR/.env"
          fi
          if [ -f "$SHARED_DIR/config/bangumi-tokens.json" ]; then
            mkdir -p "$RELEASE_DIR/config"
            ln -sfn "$SHARED_DIR/config/bangumi-tokens.json" "$RELEASE_DIR/config/bangumi-tokens.json"
          fi

          cd "$RELEASE_DIR"
          pnpm install --prod --frozen-lockfile
          pnpm dlx prisma generate

          set -a
          [ -f "$RELEASE_DIR/.env" ] && . "$RELEASE_DIR/.env"
          set +a

          if command -v psql >/dev/null 2>&1; then
            HAS_TABLES=$(psql "$DATABASE_URL" -tAc "select count(*) from information_schema.tables where table_schema='public' and table_name <> '_prisma_migrations'")
            HAS_PRISMA_TABLE=$(psql "$DATABASE_URL" -tAc "select to_regclass('_prisma_migrations') is not null")
            MIG_CNT=0
            if [ "$HAS_PRISMA_TABLE" = "t" ]; then
              MIG_CNT=$(psql "$DATABASE_URL" -tAc "select count(*) from _prisma_migrations")
            fi

            if [ "$HAS_TABLES" -gt 0 ] && { [ "$HAS_PRISMA_TABLE" = "f" ] || [ "$MIG_CNT" -eq 0 ]; }; then
              echo "Detected existing DB without Prisma migration history."
              echo "Run once in this release dir:"
              echo "pnpm dlx prisma migrate resolve --applied 0000_initial_baseline && pnpm dlx prisma migrate deploy"
              exit 1
            fi
          else
            echo "psql not found; cannot run safety check. Ensure baseline is resolved if DB is non-empty."
          fi

          if [ -d "prisma/migrations" ] && [ "$(ls -A prisma/migrations 2>/dev/null)" ]; then
            echo "Applying Prisma migrations..."
            pnpm dlx prisma migrate deploy
          else
            echo "No Prisma migrations directory or it's empty. Skipping migrate deploy."
          fi

          if [ -f "$SHARED_DIR/ecosystem.config.cjs" ]; then
            ln -sfn "$SHARED_DIR/ecosystem.config.cjs" "$RELEASE_DIR/ecosystem.config.cjs"
          fi

          rm -rf "$DEPLOY_DIR/current"
          ln -sfn "$RELEASE_DIR" "$DEPLOY_DIR/current"

          cd "$DEPLOY_DIR/current"

          pm2 restart shionlib-backend || pm2 start ecosystem.config.cjs --env production --name shionlib-backend

          cd "$DEPLOY_DIR/releases"
          ls -1dt */ | tail -n +$((KEEP_RELEASES+1)) | xargs -r rm -rf
          EOF
